<root BTCPP_format="4" main_tree_to_execute="RunawayAlarm">
    <BehaviorTree ID="RunawayAlarm">
        <KeepRunningUntilFailure>
            <Sequence>
                
                <!-- 1. Wait for Alarm Time (Ask UI first) -->
                <WaitUntilTime wake_time="ASK"/>
                
                <!-- 2. Save Start Position (After time is reached, before alarm) -->
                <SaveHomePose topic_name="/amcl_pose"/>
                
                <!-- 2. Start Alarm Sound -->
                <!-- 3. Alarm Triggered -->
            <PlaySound file="opening.wav" loop="true"/>
            
            <!-- Global Loop with Stop Interrupt -->
            <ReactiveFallback name="MissionLoop">
                <!-- Priority 1: Stop Button (Checked every tick) -->
                <IsButtonPressed/>
                
                <!-- Priority 2: Mission Sequence (Memory ensures Rotate runs once) -->
                <SequenceStar name="ActionSequence">
                    <!-- Step 1: Startup Check (Turn 180 -> Start Loop) -->
                    <Rotate angle="3.14" speed="1.5"/>
                    
                    <!-- Step 2: Main Behavior Loop -->
                    <KeepRunningUntilFailure>
                        <ReactiveFallback name="BehaviorSelection">
                            
                             <!-- Priority 1: Depth Avoidance (Safety) -->
                            <DepthAvoidance topic="/camera/depth/image_raw" threshold="0.4"/>

                            <!-- Priority 2: Flee Behavior (If Person Detected) -->
                            <Sequence name="FleeSequence">
                                <IsPersonDetected output_angle="{user_angle}"/>
                                <RunOpposite target_angle="{user_angle}" speed="1.0"/>
                                <Wait seconds="1.0"/>
                            </Sequence>
                            
                            <!-- Priority 2: Wait (Sentinel Mode) instead of Wander -->
                            <!-- User Requirement: "Wait until they come" -->
                            <!-- Priority 2: Scan Mode (Left 30, Right 30) -->
                            <Sequence name="ScanSequence">
                                <Rotate angle="0.52" speed="1.0"/> <!-- Left 30 -->
                                <Wait seconds="1.0"/>
                                <Rotate angle="-1.05" speed="1.0"/> <!-- Right 60 (to -30) -->
                                <Wait seconds="1.0"/>
                                <Rotate angle="0.52" speed="1.0"/> <!-- Center -->
                                <Wait seconds="1.0"/>
                            </Sequence>
                            
                        </ReactiveFallback>
                    </KeepRunningUntilFailure>
                </SequenceStar>
            </ReactiveFallback>
                
                <!-- 4. Cleanup & Capture -->
                <StopSound/>
                
                <!-- Turn to face user/room and Capture Memory -->
                <Rotate angle="3.14" speed="1.5"/>
                <CaptureImage topic="/camera/color/image_raw" delay="1.0"/>
                
                <Speak message="catch.wav"/>
                <Speak message="Ending.wav"/>
                
                <!-- 5. Return to Start Position -->
                <NavigateToKey bb_key_name="home_pose"/>
                
                <!-- 6. Reset Environment (Clear Costmap) -->
                <ClearCostmap service_name="/global_costmap/clear_entirely_global_costmap"/>
                
            </Sequence>
        </KeepRunningUntilFailure>
    </BehaviorTree>
    
    <TreeNodesModel>
        <Action ID="SaveHomePose">
            <input_port name="topic_name" type="std::string" default="/amcl_pose"/>
        </Action>
        <Action ID="WaitUntilTime">
            <input_port name="wake_time" type="std::string" default="07:00"/>
        </Action>
        <Action ID="PlaySound">
            <input_port name="file" type="std::string" default="opening.wav"/>
            <input_port name="loop" type="bool" default="true"/>
        </Action>
        <Action ID="StopSound"/>
        <Action ID="Speak">
            <input_port name="message" type="std::string" default="Ending.wav"/>
        </Action>
        <Action ID="NavigateToKey">
            <input_port name="bb_key_name" type="std::string"/>
        </Action>
        <Action ID="RunOpposite">
            <input_port name="target_angle" type="double"/>
            <input_port name="speed" type="double" default="1.0"/>
        </Action>
        <Action ID="Wander">
            <input_port name="speed" type="double" default="1.0"/>
        </Action>
        <Action ID="CaptureImage">
            <input_port name="topic" type="std::string" default="/camera/color/image_raw"/>
            <input_port name="delay" type="double" default="0.0"/>
        </Action>
        <Action ID="Wait">
            <input_port name="seconds" type="double" default="1.0"/>
        </Action>
        <Action ID="DriveForward">
            <input_port name="speed" type="double" default="0.2"/>
            <input_port name="seconds" type="double" default="1.0"/>
        </Action>
        <Action ID="ClearCostmap">
            <input_port name="service_name" type="std::string" default="/global_costmap/clear_entirely_global_costmap"/>
        </Action>
        <Action ID="DepthAvoidance">
             <input_port name="topic" type="std::string" default="/camera/depth/image_raw"/>
             <input_port name="threshold" type="double" default="0.4"/>
        </Action>

        <Condition ID="IsButtonPressed"/>
        <Condition ID="IsPersonDetected">
            <output_port name="output_angle" type="double"/>
        </Condition>
        
        <Decorator ID="KeepRunningUntilFailure"/>
    </TreeNodesModel>

</root>
